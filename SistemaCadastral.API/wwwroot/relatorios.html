<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Cadastral - Relatórios</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <h1>Relatórios de Pessoas</h1>
        <a href="index.html">Voltar ao Menu</a>
    </header>
    <main>
        <div class="relatorio-buttons">
            <button onclick="gerarRelatorio('basico')">Relatório Básico (CPF/CNPJ e Celular)</button>
            <button onclick="gerarRelatorio('completo')">Relatório Completo</button>
        </div>
        <div id="mensagem"></div>
        <table id="tabelaRelatorio">
            <thead id="theadRelatorio"></thead>
            <tbody id="resultados"></tbody>
        </table>
    </main>
    <script src="scripts.js"></script>
    <script>
        async function gerarRelatorio(tipo) {
            const mensagem = document.getElementById('mensagem');
            const thead = document.getElementById('theadRelatorio');
            const tbody = document.getElementById('resultados');
            mensagem.textContent = '';
            thead.innerHTML = '';
            tbody.innerHTML = '';

            try {
                const response = await fetch(`/api/Pessoa/relatorio/${tipo}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    const dados = await response.json();
                    if (tipo === 'basico') {
                        thead.innerHTML = `
                            <tr>
                                <th>CPF/CNPJ</th>
                                <th>Celular</th>
                            </tr>
                        `;
                        dados.forEach(item => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${formatCpfCnpj(item.cpfCnpj)}</td>
                                <td>${formatCelular(item.celular)}</td>
                            `;
                            tbody.appendChild(tr);
                        });
                    } else {
                        thead.innerHTML = `
                            <tr>
                                <th>ID</th>
                                <th>Nome</th>
                                <th>CPF/CNPJ</th>
                                <th>Tipo</th>
                                <th>Cidade</th>
                                <th>Estado</th>
                                <th>Data Cadastro</th>
                                <th>Idade</th>
                            </tr>
                        `;
                        dados.forEach(pessoa => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `
                                <td>${pessoa.id}</td>
                                <td>${pessoa.nome}</td>
                                <td>${formatCpfCnpj(pessoa.cpfCnpj)}</td>
                                <td>${pessoa.tipoPessoa === 'FI' ? 'Física' : 'Jurídica'}</td>
                                <td>${pessoa.cidade?.nome || ''}</td>
                                <td>${pessoa.cidade?.estado || ''}</td>
                                <td>${new Date(pessoa.dataCadastro).toLocaleDateString('pt-BR')}</td>
                                <td>${calcularIdade(pessoa.dataNascimentoFundacao)}</td>
                            `;
                            tbody.appendChild(tr);
                        });
                    }
                    if (dados.length === 0) {
                        mensagem.textContent = 'Nenhum registro encontrado.';
                    }
                } else {
                    mensagem.textContent = await response.text();
                    mensagem.classList.add('error');
                }
            } catch (err) {
                mensagem.textContent = 'Erro ao conectar com o servidor.';
                mensagem.classList.add('error');
                console.error(err);
            }
        }
    </script>
</body>
</html>